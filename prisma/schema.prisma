// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==============================================
// USER MANAGEMENT & AUTHENTICATION
// ==============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String?   @map("password_hash") // Nullable for OAuth users
  firstName     String    @map("first_name")
  lastName      String    @map("last_name")
  phone         String?
  address       String?
  avatarUrl     String?   @map("avatar_url")
  emailVerified Boolean   @default(false) @map("email_verified")
  isActive      Boolean   @default(true) @map("is_active")
  role          UserRole  @default(CUSTOMER)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  stripeCustomerId String? @map("stripe_customer_id")
  metadata         Json?
  
  // Onboarding fields
  onboardingCompleted  Boolean   @default(false) @map("onboarding_completed")
  onboardingSkippedAt  DateTime? @map("onboarding_skipped_at")
  createdViaCheckout   Boolean   @default(false) @map("created_via_checkout")
  welcomeShown         Boolean   @default(false) @map("welcome_shown")
  lastLoginAt          DateTime? @map("last_login_at")
  referralSource       String?   @map("referral_source") // How they heard about us
  businessGoals        String?   @map("business_goals")   // What they want to achieve
  
  // Relationships
  orders           Order[]
  userSessions     UserSession[]
  oauthAccounts    OAuthAccount[]
  businesses       Business[]       // User can have multiple businesses
  businessMembers  BusinessMember[] // User can be member of other businesses
  
  @@map("users")
}

model OAuthAccount {
  id                String   @id @default(cuid())
  userId            String   @map("user_id")
  provider          OAuthProvider
  providerAccountId String   @map("provider_account_id")
  accessToken       String?  @map("access_token")
  refreshToken      String?  @map("refresh_token")
  expiresAt         DateTime? @map("expires_at")
  tokenType         String?  @map("token_type")
  scope             String?
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([provider, providerAccountId])
  @@map("oauth_accounts")
}

model UserSession {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  sessionToken String  @unique @map("session_token")
  expiresAt   DateTime @map("expires_at")
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  createdAt   DateTime @default(now()) @map("created_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("user_sessions")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  
  @@map("password_reset_tokens")
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  
  @@map("email_verification_tokens")
}

enum UserRole {
  CUSTOMER    @map("customer")
  ADMIN       @map("admin")
  SUPER_ADMIN @map("super_admin")
}

enum OAuthProvider {
  GOOGLE   @map("google")
  FACEBOOK @map("facebook")
  APPLE    @map("apple")
}

// ==============================================
// BUSINESS ENTITY MANAGEMENT
// ==============================================

model Business {
  id              String   @id @default(cuid())
  ownerId         String   @map("owner_id")
  
  // Business Information
  name            String
  legalName       String?  @map("legal_name") // e.g., "Company Name LLC"
  entityType      BusinessEntityType @default(LLC) @map("entity_type")
  state           String   @default("CA") // Formation state
  status          BusinessStatus @default(PENDING)
  
  // Formation Details (for new LLCs)
  formationOrderId String?  @unique @map("formation_order_id")
  formationDate   DateTime? @map("formation_date")
  einNumber       String?   @map("ein_number")
  stateFileNumber String?   @map("state_file_number")
  
  // Contact & Address
  businessAddress String?  @map("business_address")
  businessCity    String?  @map("business_city")
  businessZip     String?  @map("business_zip")
  phone           String?
  email           String?
  website         String?
  
  // External & Existing Business Info
  isExisting      Boolean  @default(false) @map("is_existing") // True if imported, not formed through us
  externalId      String?  @map("external_id") // For tracking external references
  
  // Compliance & Important Dates
  annualReportDueDate   DateTime? @map("annual_report_due_date")
  franchiseTaxDueDate   DateTime? @map("franchise_tax_due_date")
  registeredAgentExpiry DateTime? @map("registered_agent_expiry")
  
  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  // Relationships
  owner           User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  formationOrder  Order?   @relation("BusinessFormation", fields: [formationOrderId], references: [id])
  members         BusinessMember[]
  documents       BusinessDocument[]
  events          BusinessEvent[]
  services        BusinessService[]
  complianceTasks ComplianceTask[]
  notes           BusinessNote[]
  
  @@map("businesses")
}

model BusinessMember {
  id          String   @id @default(cuid())
  businessId  String   @map("business_id")
  userId      String?  @map("user_id") // Nullable if member doesn't have account
  
  // Member Info
  name        String
  email       String?
  phone       String?
  role        BusinessMemberRole @default(MEMBER)
  title       String? // e.g., "Managing Member", "CFO"
  
  // Ownership
  ownershipPercentage Float? @map("ownership_percentage")
  
  // Permissions
  canViewDocuments  Boolean @default(true) @map("can_view_documents")
  canUploadDocuments Boolean @default(false) @map("can_upload_documents")
  canManageServices Boolean @default(false) @map("can_manage_services")
  canInviteMembers  Boolean @default(false) @map("can_invite_members")
  
  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@unique([businessId, email])
  @@map("business_members")
}

model BusinessDocument {
  id           String   @id @default(cuid())
  businessId   String   @map("business_id")
  
  // Document Info
  category     DocumentCategory
  name         String
  fileName     String   @map("file_name")
  filePath     String   @map("file_path")
  fileSize     Int?     @map("file_size")
  mimeType     String?  @map("mime_type")
  
  // Status
  isLatest     Boolean  @default(true) @map("is_latest")
  isFinal      Boolean  @default(false) @map("is_final")
  
  // Metadata
  description  String?
  uploadedBy   String?  @map("uploaded_by") // User ID who uploaded
  
  // Timestamps
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  
  business     Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@map("business_documents")
}

model BusinessEvent {
  id          String   @id @default(cuid())
  businessId  String   @map("business_id")
  
  // Event Info
  title       String
  description String?
  eventType   BusinessEventType @map("event_type")
  
  // Date & Time
  startDate   DateTime @map("start_date")
  endDate     DateTime? @map("end_date")
  isAllDay    Boolean  @default(false) @map("is_all_day")
  
  // Reminders
  reminderDays Int?     @map("reminder_days") // Days before to remind
  isRecurring  Boolean  @default(false) @map("is_recurring")
  recurringRule String? @map("recurring_rule") // RRULE format
  
  // Status
  status      EventStatus @default(UPCOMING)
  completedAt DateTime?   @map("completed_at")
  
  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@map("business_events")
}

model BusinessService {
  id          String   @id @default(cuid())
  businessId  String   @map("business_id")
  
  // Service Info
  serviceType ServiceCategory @map("service_type")
  name        String
  description String?
  
  // Billing
  price       Decimal  @db.Decimal(10, 2)
  billingCycle BillingCycle? @map("billing_cycle")
  
  // Status
  status      ServiceStatus @default(ACTIVE)
  startDate   DateTime @map("start_date")
  endDate     DateTime? @map("end_date")
  renewalDate DateTime? @map("renewal_date")
  
  // External References
  stripeSubscriptionId String? @map("stripe_subscription_id")
  orderId     String?  @map("order_id") // Reference to original order if applicable
  
  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@map("business_services")
}

model ComplianceTask {
  id          String   @id @default(cuid())
  businessId  String   @map("business_id")
  
  // Task Info
  title       String
  description String?
  taskType    ComplianceTaskType @map("task_type")
  
  // Dates
  dueDate     DateTime @map("due_date")
  reminderDate DateTime? @map("reminder_date")
  
  // Status
  status      ComplianceTaskStatus @default(PENDING)
  completedAt DateTime? @map("completed_at")
  completedBy String?   @map("completed_by") // User ID
  
  // Additional Info
  notes       String?
  documentId  String?  @map("document_id") // Reference to related document
  
  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@map("compliance_tasks")
}

model BusinessNote {
  id          String   @id @default(cuid())
  businessId  String   @map("business_id")
  
  // Note Info
  title       String?
  content     String
  isPinned    Boolean  @default(false) @map("is_pinned")
  
  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdBy   String?  @map("created_by") // User ID
  
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@map("business_notes")
}

enum BusinessEntityType {
  LLC                @map("llc")
  CORPORATION        @map("corporation")
  S_CORPORATION      @map("s_corporation")
  SOLE_PROPRIETORSHIP @map("sole_proprietorship")
  PARTNERSHIP        @map("partnership")
  NON_PROFIT         @map("non_profit")
}

enum BusinessStatus {
  PENDING       @map("pending")       // Formation in progress
  ACTIVE        @map("active")        // Active and in good standing
  INACTIVE      @map("inactive")      // Not currently operating
  SUSPENDED     @map("suspended")     // Suspended by state
  DISSOLVED     @map("dissolved")     // Officially dissolved
}

enum BusinessMemberRole {
  OWNER          @map("owner")
  MEMBER         @map("member")
  MANAGER        @map("manager")
  VIEWER         @map("viewer")
}

enum DocumentCategory {
  FORMATION      @map("formation")     // Articles, Operating Agreement
  TAX            @map("tax")           // Tax returns, EIN
  COMPLIANCE     @map("compliance")    // Annual reports, licenses
  FINANCIAL      @map("financial")     // Bank statements, invoices
  LEGAL          @map("legal")         // Contracts, agreements
  OTHER          @map("other")
}

enum BusinessEventType {
  DEADLINE       @map("deadline")      // Filing deadlines
  RENEWAL        @map("renewal")       // Service renewals
  MEETING        @map("meeting")       // Business meetings
  TAX_DUE        @map("tax_due")       // Tax payment due dates
  REMINDER       @map("reminder")      // General reminders
  MILESTONE      @map("milestone")     // Business milestones
}

enum EventStatus {
  UPCOMING       @map("upcoming")
  IN_PROGRESS    @map("in_progress")
  COMPLETED      @map("completed")
  OVERDUE        @map("overdue")
  CANCELLED      @map("cancelled")
}

enum ServiceCategory {
  LLC_FORMATION      @map("llc_formation")
  REGISTERED_AGENT   @map("registered_agent")
  COMPLIANCE_PACKAGE @map("compliance_package")
  WEBSITE_BASIC      @map("website_basic")
  WEBSITE_PRO        @map("website_pro")
  WEBSITE_GROWTH     @map("website_growth")
  EIN_SERVICE        @map("ein_service")
  ANNUAL_REPORT      @map("annual_report")
  OTHER              @map("other")
}

enum ServiceStatus {
  PENDING        @map("pending")
  ACTIVE         @map("active")
  PAUSED         @map("paused")
  CANCELLED      @map("cancelled")
  EXPIRED        @map("expired")
}

enum ComplianceTaskType {
  ANNUAL_REPORT      @map("annual_report")
  FRANCHISE_TAX      @map("franchise_tax")
  BUSINESS_LICENSE   @map("business_license")
  REGISTERED_AGENT   @map("registered_agent")
  STATEMENT_INFO     @map("statement_info")
  TAX_FILING         @map("tax_filing")
  OTHER              @map("other")
}

enum ComplianceTaskStatus {
  PENDING        @map("pending")
  IN_PROGRESS    @map("in_progress")
  COMPLETED      @map("completed")
  OVERDUE        @map("overdue")
  NOT_APPLICABLE @map("not_applicable")
}

// ==============================================
// STATE FEES & PRICING CONFIGURATION
// ==============================================

// State LLC filing fees - can be managed via admin panel
model StateFee {
  id              String   @id @default(cuid())
  stateCode       String   @unique @map("state_code") // e.g., "CA", "TX", "NY"
  stateName       String   @map("state_name")         // e.g., "California", "Texas"
  
  // Filing Fees
  filingFee       Decimal  @map("filing_fee") @db.Decimal(10, 2)
  rushFee         Decimal? @map("rush_fee") @db.Decimal(10, 2)     // Optional rush processing fee
  rushAvailable   Boolean  @default(false) @map("rush_available")
  rushDays        Int?     @map("rush_days")                        // Processing time with rush (days)
  standardDays    Int      @default(7) @map("standard_days")        // Normal processing time (days)
  
  // Additional state-specific fees
  annualReportFee Decimal? @map("annual_report_fee") @db.Decimal(10, 2)
  franchiseTaxFee Decimal? @map("franchise_tax_fee") @db.Decimal(10, 2)
  
  // State-specific requirements
  requiresPublishedNotice Boolean @default(false) @map("requires_published_notice")
  publishedNoticeFee      Decimal? @map("published_notice_fee") @db.Decimal(10, 2)
  
  // Status
  isActive        Boolean  @default(true) @map("is_active")
  
  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  @@map("state_fees")
}

// Registered Agent Pricing - can be managed via admin panel
model RegisteredAgentPricing {
  id              String   @id @default(cuid())
  stateCode       String   @unique @map("state_code") // e.g., "CA", "TX" or "ALL" for default
  
  // Pricing
  annualFee       Decimal  @map("annual_fee") @db.Decimal(10, 2)
  firstYearFee    Decimal? @map("first_year_fee") @db.Decimal(10, 2) // Promotional first year pricing
  
  // Included with formation
  includedWithFormation   Boolean @default(false) @map("included_with_formation")
  includedMonths         Int?     @map("included_months")          // e.g., first 6 months free with formation
  
  // Status
  isActive        Boolean  @default(true) @map("is_active")
  
  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  @@map("registered_agent_pricing")
}

// Service Pricing - Base prices for services (managed via admin panel)
model ServicePricing {
  id              String   @id @default(cuid())
  serviceKey      String   @unique @map("service_key") // e.g., "llc_formation", "ein", "operating_agreement"
  serviceName     String   @map("service_name")
  description     String?
  
  // Pricing
  basePrice       Decimal  @map("base_price") @db.Decimal(10, 2)
  
  // Optional recurring pricing
  isRecurring     Boolean  @default(false) @map("is_recurring")
  recurringPrice  Decimal? @map("recurring_price") @db.Decimal(10, 2)
  billingCycle    BillingCycle? @map("billing_cycle")
  
  // Status
  isActive        Boolean  @default(true) @map("is_active")
  isRequired      Boolean  @default(false) @map("is_required") // Required service (e.g., LLC formation itself)
  
  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  @@map("service_pricing")
}

// ==============================================
// LLC FORMATION ORDERS ($99.99 + STATE FEES)
// ==============================================

model Order {
  id       String @id @default(cuid())
  orderId  String @unique @map("order_id") // ORD-timestamp-random format
  userId   String? @map("user_id")
  businessId String? @map("business_id") // Link to business entity
  
  // Basic Company Information
  companyName     String @map("company_name")
  businessAddress String @map("business_address")
  businessCity    String @map("business_city")
  businessState   String @map("business_state") @default("CA")
  businessZip     String @map("business_zip")
  businessPurpose String @map("business_purpose")
  
  // Contact Information
  contactFirstName String @map("contact_first_name")
  contactLastName  String @map("contact_last_name")
  contactEmail     String @map("contact_email")
  contactPhone     String? @map("contact_phone")
  contactAddress   String? @map("contact_address")
  
  // Service Selections (all included in $99.99)
  needEIN              Boolean @default(true) @map("need_ein")
  needOperatingAgreement Boolean @default(true) @map("need_operating_agreement")
  needBankLetter       Boolean @default(true) @map("need_bank_letter")
  registeredAgent      Boolean @default(false) @map("registered_agent") // Required by law add-on
  compliance           Boolean @default(false) // Optional add-on
  websiteService       WebsiteServiceTier? @map("website_service") // Optional tiered website service
  
  // Formation State & Rush Processing
  formationState       String @default("CA") @map("formation_state") // State where LLC is being formed
  rushProcessing       Boolean @default(false) @map("rush_processing")
  
  // Pricing ($99.99 base + state fees + optional add-ons)
  basePrice            Decimal @default(99.99) @map("base_price") @db.Decimal(10, 2)
  stateFilingFee       Decimal @default(0.00) @map("state_filing_fee") @db.Decimal(10, 2)
  rushFee              Decimal @default(0.00) @map("rush_fee") @db.Decimal(10, 2)
  registeredAgentPrice Decimal @default(149.00) @map("registered_agent_price") @db.Decimal(10, 2)
  compliancePrice      Decimal @default(99.00) @map("compliance_price") @db.Decimal(10, 2)
  websiteSetupFee      Decimal @default(0.00) @map("website_setup_fee") @db.Decimal(10, 2) // One-time setup fee
  totalAmount          Decimal @map("total_amount") @db.Decimal(10, 2)
  
  // Order Status & Processing
  status          OrderStatus @default(PENDING_PROCESSING)
  priority        OrderPriority @default(NORMAL)
  
  // Payment Information
  paymentMethod        PaymentMethod @default(STRIPE) @map("payment_method")
  paymentStatus        PaymentStatus @default(PENDING) @map("payment_status")
  paymentTransactionId String? @map("payment_transaction_id")
  paymentDate          DateTime? @map("payment_date")
  
  // State Filing Information
  stateFilingDate   DateTime? @map("state_filing_date")
  stateFilingNumber String? @map("state_filing_number")
  ein               String? // Federal EIN when obtained
  einIssuedDate     DateTime? @map("ein_issued_date")
  
  // Processing Information
  articlesGenerated   Boolean @default(false) @map("articles_generated")
  operatingAgreementGenerated Boolean @default(false) @map("operating_agreement_generated")
  bankLetterGenerated Boolean @default(false) @map("bank_letter_generated")
  einObtained        Boolean @default(false) @map("ein_obtained")
  
  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  completedAt DateTime? @map("completed_at")
  
  // Internal Management
  assignedTo    String? @map("assigned_to") // Admin user ID
  internalNotes String? @map("internal_notes")
  customerNotes String? @map("customer_notes")
  
  // Relationships
  user               User? @relation(fields: [userId], references: [id], onDelete: SetNull)
  business           Business? @relation("BusinessFormation")
  operatingAgreement OperatingAgreement?
  statusHistory      OrderStatusHistory[]
  communications     Communication[]
  documents          Document[]
  websiteSubscription WebsiteSubscription?
  subscriptionIntents SubscriptionIntent[]
  
  @@map("orders")
}

// ==============================================
// WEBSITE SERVICES & SUBSCRIPTIONS
// ==============================================

model WebsiteSubscription {
  id          String @id @default(cuid())
  orderId     String @unique @map("order_id")
  order       Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  // Subscription Details
  tier               WebsiteServiceTier @map("service_tier")
  monthlyPrice       Decimal @map("monthly_price") @db.Decimal(10, 2)
  setupFee           Decimal @default(0.00) @map("setup_fee") @db.Decimal(10, 2)
  
  // Subscription Status
  status             SubscriptionStatus @default(PENDING)
  
  // Billing & Payment
  stripeSubscriptionId String? @map("stripe_subscription_id")
  stripePriceId        String? @map("stripe_price_id")
  billingCycle         BillingCycle @default(MONTHLY) @map("billing_cycle")
  
  // Dates
  startDate          DateTime @map("start_date")
  endDate            DateTime? @map("end_date") // null for active subscriptions
  nextBillingDate    DateTime? @map("next_billing_date")
  cancelledAt        DateTime? @map("cancelled_at")
  pausedAt           DateTime? @map("paused_at")
  
  // Trial (if applicable)
  trialEndsAt        DateTime? @map("trial_ends_at")
  isTrialActive      Boolean @default(false) @map("is_trial_active")
  
  // Website Details
  domainName         String? @map("domain_name")
  websiteUrl         String? @map("website_url")
  websiteStatus      WebsiteStatus @default(PENDING) @map("website_status")
  
  // Analytics & Marketing (for Growth tier)
  googleAnalyticsId  String? @map("google_analytics_id")
  facebookPixelId    String? @map("facebook_pixel_id")
  googleAdsAccountId String? @map("google_ads_account_id")
  
  // Support & Features
  chatWidgetEnabled  Boolean @default(false) @map("chat_widget_enabled")
  schedulingEnabled  Boolean @default(false) @map("scheduling_enabled")
  marketingEnabled   Boolean @default(false) @map("marketing_enabled")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Relationships
  billingHistory WebsiteBilling[]
  marketingCampaigns MarketingCampaign[]
  websiteAnalytics WebsiteAnalytics[]
  
  @@map("website_subscriptions")
}

model WebsiteBilling {
  id                   String @id @default(cuid())
  websiteSubscriptionId String @map("website_subscription_id")
  websiteSubscription  WebsiteSubscription @relation(fields: [websiteSubscriptionId], references: [id], onDelete: Cascade)
  
  // Billing Details
  amount               Decimal @db.Decimal(10, 2)
  currency             String @default("USD")
  billingPeriodStart   DateTime @map("billing_period_start")
  billingPeriodEnd     DateTime @map("billing_period_end")
  
  // Payment Processing
  stripeInvoiceId      String? @map("stripe_invoice_id")
  paymentStatus        PaymentStatus @map("payment_status")
  paidAt               DateTime? @map("paid_at")
  failureReason        String? @map("failure_reason")
  
  createdAt DateTime @default(now()) @map("created_at")
  
  @@map("website_billing")
}

model MarketingCampaign {
  id                   String @id @default(cuid())
  websiteSubscriptionId String @map("website_subscription_id")
  websiteSubscription  WebsiteSubscription @relation(fields: [websiteSubscriptionId], references: [id], onDelete: Cascade)
  
  // Campaign Details
  campaignName         String @map("campaign_name")
  campaignType         MarketingCampaignType @map("campaign_type")
  status               CampaignStatus @default(DRAFT)
  
  // Budget & Spend
  monthlyBudget        Decimal? @map("monthly_budget") @db.Decimal(10, 2)
  totalSpent           Decimal @default(0.00) @map("total_spent") @db.Decimal(10, 2)
  
  // Platform IDs
  googleAdsId          String? @map("google_ads_id")
  facebookCampaignId   String? @map("facebook_campaign_id")
  
  // Targeting
  targetAudience       String? @map("target_audience")
  keywords             String? // JSON array of keywords
  demographics         String? // JSON object with targeting info
  
  // Performance
  impressions          Int @default(0)
  clicks               Int @default(0)
  conversions          Int @default(0)
  ctr                  Float @default(0.0) // Click-through rate
  cpc                  Float @default(0.0) @map("cost_per_click") // Cost per click
  
  // Dates
  startDate            DateTime @map("start_date")
  endDate              DateTime? @map("end_date")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@map("marketing_campaigns")
}

model WebsiteAnalytics {
  id                   String @id @default(cuid())
  websiteSubscriptionId String @map("website_subscription_id")
  websiteSubscription  WebsiteSubscription @relation(fields: [websiteSubscriptionId], references: [id], onDelete: Cascade)
  
  // Date for analytics (daily aggregation)
  date                 DateTime @db.Date
  
  // Traffic Metrics
  pageViews            Int @default(0) @map("page_views")
  uniqueVisitors       Int @default(0) @map("unique_visitors")
  sessions             Int @default(0)
  bounceRate           Float @default(0.0) @map("bounce_rate")
  avgSessionDuration   Int @default(0) @map("avg_session_duration") // in seconds
  
  // Conversion Metrics
  contactFormSubmissions Int @default(0) @map("contact_form_submissions")
  phoneCallClicks        Int @default(0) @map("phone_call_clicks")
  appointmentsScheduled  Int @default(0) @map("appointments_scheduled")
  chatConversations      Int @default(0) @map("chat_conversations")
  
  // Traffic Sources
  organicTraffic       Int @default(0) @map("organic_traffic")
  paidTraffic          Int @default(0) @map("paid_traffic")
  socialTraffic        Int @default(0) @map("social_traffic")
  directTraffic        Int @default(0) @map("direct_traffic")
  referralTraffic      Int @default(0) @map("referral_traffic")
  
  // Performance
  loadTime             Float @default(0.0) @map("avg_load_time") // in seconds
  mobileTraffic        Int @default(0) @map("mobile_traffic")
  desktopTraffic       Int @default(0) @map("desktop_traffic")
  
  createdAt DateTime @default(now()) @map("created_at")
  
  @@unique([websiteSubscriptionId, date])
  @@map("website_analytics")
}

enum WebsiteServiceTier {
  BASIC  @map("basic")   // $9.99/month - Simple information website
  PRO    @map("pro")     // $49.99/month - Web chat and scheduling
  GROWTH @map("growth")  // $349.99/month - Marketing and optimization
}

enum SubscriptionStatus {
  PENDING    @map("pending")     // Awaiting setup
  ACTIVE     @map("active")      // Currently active
  PAUSED     @map("paused")      // Temporarily paused
  CANCELLED  @map("cancelled")   // Cancelled by customer
  EXPIRED    @map("expired")     // Payment failed/expired
  SUSPENDED  @map("suspended")   // Suspended by admin
}

enum BillingCycle {
  MONTHLY @map("monthly")
  YEARLY  @map("yearly")
}

enum WebsiteStatus {
  PENDING     @map("pending")      // Not yet started
  SETUP       @map("setup")        // In development
  REVIEW      @map("review")       // Ready for customer review
  LIVE        @map("live")         // Website is live
  MAINTENANCE @map("maintenance")  // Under maintenance
  SUSPENDED   @map("suspended")    // Suspended
}

enum MarketingCampaignType {
  GOOGLE_ADS     @map("google_ads")
  FACEBOOK_ADS   @map("facebook_ads")
  SEO_ORGANIC    @map("seo_organic")
  CONTENT_MARKETING @map("content_marketing")
  EMAIL_MARKETING   @map("email_marketing")
  SOCIAL_MEDIA     @map("social_media")
}

enum CampaignStatus {
  DRAFT      @map("draft")
  ACTIVE     @map("active")
  PAUSED     @map("paused")
  COMPLETED  @map("completed")
  CANCELLED  @map("cancelled")
}

enum OrderStatus {
  PENDING_PROCESSING   @map("pending_processing")
  PROCESSING_ARTICLES  @map("processing_articles")
  ARTICLES_FILED      @map("articles_filed")
  OBTAINING_EIN       @map("obtaining_ein")
  GENERATING_DOCUMENTS @map("generating_documents")
  COMPLETED           @map("completed")
  CANCELLED           @map("cancelled")
  REFUNDED            @map("refunded")
}

enum OrderPriority {
  NORMAL  @map("normal")
  HIGH    @map("high")
  URGENT  @map("urgent")
}

enum PaymentMethod {
  STRIPE  @map("stripe")
  PAYPAL  @map("paypal")
}

enum PaymentStatus {
  PENDING   @map("pending")
  COMPLETED @map("completed")
  FAILED    @map("failed")
  REFUNDED  @map("refunded")
}

// ==============================================
// OPERATING AGREEMENT QUESTIONS & DATA
// ==============================================

model OperatingAgreement {
  id        String @id @default(cuid())
  orderId   String @unique @map("order_id")
  order     Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  // Basic LLC Information
  formationDate     DateTime? @map("formation_date")
  businessStartDate DateTime? @map("business_start_date")
  principalActivity String? @map("principal_activity")
  duration          CompanyDuration @default(PERPETUAL)
  fixedEndDate      DateTime? @map("fixed_end_date")
  fiscalYearEnd     FiscalYearEnd @default(DECEMBER)
  
  // Member Information
  memberCount       Int @map("member_count") @default(1)
  isSingleMember    Boolean @default(true) @map("is_single_member")
  
  // Management Structure
  managementType    ManagementType @default(MEMBER_MANAGED) @map("management_type")
  votingStructure   VotingStructure? @map("voting_structure") // null for single-member
  majorDecisionRule DecisionRule? @map("major_decision_rule") // null for single-member
  
  // Financial Settings
  profitDistMethod  DistributionMethod @default(PROPORTIONAL) @map("profit_dist_method")
  distFrequency     DistributionFrequency @default(AS_DECIDED) @map("dist_frequency")
  taxClassification TaxClassification @default(DISREGARDED_ENTITY) @map("tax_classification")
  
  // Transfer & Withdrawal Settings
  allowMemberTransfer     Boolean @default(false) @map("allow_member_transfer")
  transferToNonMembers    Boolean? @map("transfer_to_non_members") // null for single-member
  rightOfFirstRefusal     Boolean? @map("right_of_first_refusal") // null for single-member
  familyTransferAllowed   Boolean @default(true) @map("family_transfer_allowed")
  valuationMethod         ValuationMethod @default(BOOK_VALUE) @map("valuation_method")
  withdrawalRule          DecisionRule? @map("withdrawal_rule") // null for single-member
  withdrawalPaymentMethod PaymentMethod? @map("withdrawal_payment_method") // null for single-member
  
  // Meetings & Governance
  requireMeetings        Boolean @default(false) @map("require_meetings")
  meetingFrequency       MeetingFrequency? @map("meeting_frequency") // null for single-member
  virtualMeetingsAllowed Boolean? @map("virtual_meetings_allowed") // null for single-member
  meetingNoticeDays      Int? @map("meeting_notice_days") // null for single-member
  quorumRequirement      QuorumType? @map("quorum_requirement") // null for single-member
  
  // Reporting & Records
  provideTaxReturns    Boolean @default(true) @map("provide_tax_returns")
  provideProfitLoss    Boolean @default(true) @map("provide_profit_loss")
  provideBalanceSheet  Boolean @default(false) @map("provide_balance_sheet")
  financialPreparedBy  ReportPreparer @default(COMPANY_MEMBER) @map("financial_prepared_by")
  recordsLocation      String? @map("records_location")
  recordsMaintenedBy   String? @map("records_maintained_by")
  
  // Legal & Compliance
  disputeResolution       DisputeResolution @default(CALIFORNIA_COURTS) @map("dispute_resolution")
  witnessRequired         Boolean @default(false) @map("witness_required")
  notarizationRequired    Boolean @default(false) @map("notarization_required")
  
  // Additional Terms
  additionalTerms String? @map("additional_terms")
  
  // Status
  isCompleted      Boolean @default(false) @map("is_completed")
  documentGenerated Boolean @default(false) @map("document_generated")
  documentUrl      String? @map("document_url")
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Relationships
  members               LLCMember[]
  managers              LLCManager[]
  unanimousConsentItems UnanimousConsentItem[]
  bankingAuthorizations BankingAuthorization[]
  dissolutionTriggers   DissolutionTrigger[]
  
  @@map("operating_agreements")
}

model LLCMember {
  id                    String @id @default(cuid())
  operatingAgreementId  String @map("operating_agreement_id")
  operatingAgreement    OperatingAgreement @relation(fields: [operatingAgreementId], references: [id], onDelete: Cascade)
  
  // Personal Information
  fullName            String @map("full_name")
  memberType          MemberType @map("member_type")
  entityType          String? @map("entity_type") // if member is entity
  streetAddress       String @map("street_address")
  city                String
  state               String
  zipCode             String @map("zip_code")
  phone               String?
  email               String
  ssn                 String? // For responsible party
  
  // Ownership Details
  ownershipPercentage Float? @map("ownership_percentage")
  ownershipUnits      Int? @map("ownership_units")
  
  // Role & Responsibilities
  isResponsibleParty    Boolean @default(false) @map("is_responsible_party")
  timeCommitmentRequired Boolean @default(false) @map("time_commitment_required")
  hoursPerWeek          Int? @map("hours_per_week")
  
  // Financial
  guaranteedPayments Boolean @default(false) @map("guaranteed_payments")
  guaranteedAmount   Float? @map("guaranteed_amount")
  
  // Relationships
  contributions MemberContribution[]
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@map("llc_members")
}

model LLCManager {
  id                   String @id @default(cuid())
  operatingAgreementId String @map("operating_agreement_id")
  operatingAgreement   OperatingAgreement @relation(fields: [operatingAgreementId], references: [id], onDelete: Cascade)
  
  name         String
  isAlsoMember Boolean @default(false) @map("is_also_member")
  memberId     String? @map("member_id") // if manager is also a member
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@map("llc_managers")
}

model MemberContribution {
  id         String @id @default(cuid())
  memberId   String @map("member_id")
  member     LLCMember @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  contributionType ContributionType @map("contribution_type")
  description      String
  value            Float
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@map("member_contributions")
}

model UnanimousConsentItem {
  id                   String @id @default(cuid())
  operatingAgreementId String @map("operating_agreement_id")
  operatingAgreement   OperatingAgreement @relation(fields: [operatingAgreementId], references: [id], onDelete: Cascade)
  
  itemType          UnanimousConsentType @map("item_type")
  customDescription String? @map("custom_description")
  dollarThreshold   Float? @map("dollar_threshold") // for debt/expense thresholds
  
  createdAt DateTime @default(now()) @map("created_at")
  
  @@map("unanimous_consent_items")
}

model BankingAuthorization {
  id                   String @id @default(cuid())
  operatingAgreementId String @map("operating_agreement_id")
  operatingAgreement   OperatingAgreement @relation(fields: [operatingAgreementId], references: [id], onDelete: Cascade)
  
  authorizationType BankingAuthType @map("authorization_type")
  specificMembers   String? @map("specific_members") // comma-separated member names if specific
  dollarThreshold   Float? @map("dollar_threshold") // for multi-signature requirements
  
  createdAt DateTime @default(now()) @map("created_at")
  
  @@map("banking_authorizations")
}

model DissolutionTrigger {
  id                   String @id @default(cuid())
  operatingAgreementId String @map("operating_agreement_id")
  operatingAgreement   OperatingAgreement @relation(fields: [operatingAgreementId], references: [id], onDelete: Cascade)
  
  triggerType       DissolutionTriggerType @map("trigger_type")
  customDescription String? @map("custom_description")
  
  createdAt DateTime @default(now()) @map("created_at")
  
  @@map("dissolution_triggers")
}

// ==============================================
// ORDER TRACKING & COMMUNICATIONS
// ==============================================

model OrderStatusHistory {
  id             String      @id @default(cuid())
  orderId        String      @map("order_id")
  previousStatus OrderStatus? @map("previous_status")
  newStatus      OrderStatus @map("new_status")
  changedBy      String      @map("changed_by") // user ID or 'system'
  notes          String?
  createdAt      DateTime    @default(now()) @map("created_at")
  
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  @@map("order_status_history")
}

model Communication {
  id             String            @id @default(cuid())
  orderId        String            @map("order_id")
  type           CommunicationType
  subject        String?
  content        String?
  recipientEmail String?           @map("recipient_email")
  sentAt         DateTime          @default(now()) @map("sent_at")
  status         CommunicationStatus @default(SENT)
  
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  @@map("communications")
}

enum CommunicationType {
  EMAIL_CONFIRMATION  @map("email_confirmation")
  EMAIL_STATUS_UPDATE @map("email_status_update")
  EMAIL_COMPLETION    @map("email_completion")
  SMS_NOTIFICATION    @map("sms_notification")
  INTERNAL_NOTE       @map("internal_note")
}

enum CommunicationStatus {
  PENDING   @map("pending")
  SENT      @map("sent")
  DELIVERED @map("delivered")
  FAILED    @map("failed")
  BOUNCED   @map("bounced")
}

// ==============================================
// DOCUMENT MANAGEMENT
// ==============================================

model Document {
  id           String       @id @default(cuid())
  orderId      String       @map("order_id")
  documentType DocumentType @map("document_type")
  fileName     String       @map("file_name")
  filePath     String       @map("file_path")
  fileSize     Int?         @map("file_size")
  isLatest     Boolean      @default(true) @map("is_latest")
  isFinal      Boolean      @default(false) @map("is_final")
  generatedAt  DateTime     @default(now()) @map("generated_at")
  
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  @@map("documents")
}

enum DocumentType {
  ARTICLES_OF_ORGANIZATION   @map("articles_of_organization")
  OPERATING_AGREEMENT       @map("operating_agreement")
  EIN_CONFIRMATION         @map("ein_confirmation")
  BANK_RESOLUTION_LETTER   @map("bank_resolution_letter")
  INVOICE                  @map("invoice")
  RECEIPT                  @map("receipt")
}

// ==============================================
// OPERATING AGREEMENT ENUMS
// ==============================================

enum CompanyDuration {
  PERPETUAL     @map("perpetual")
  FIXED_PERIOD  @map("fixed_period")
}

enum FiscalYearEnd {
  DECEMBER @map("december")
  CUSTOM   @map("custom")
}

enum ManagementType {
  MEMBER_MANAGED  @map("member_managed")
  MANAGER_MANAGED @map("manager_managed")
}

enum VotingStructure {
  PROPORTIONAL @map("proportional")
  EQUAL_VOTE   @map("equal_vote")
  CUSTOM       @map("custom")
}

enum DecisionRule {
  UNANIMOUS     @map("unanimous")
  MAJORITY      @map("majority")
  SUPERMAJORITY @map("supermajority")
}

enum DistributionMethod {
  PROPORTIONAL  @map("proportional")
  EQUAL_SHARES  @map("equal_shares")
  CUSTOM        @map("custom")
}

enum DistributionFrequency {
  AS_DECIDED @map("as_decided")
  ANNUALLY   @map("annually")
  QUARTERLY  @map("quarterly")
  MONTHLY    @map("monthly")
  NEVER      @map("never")
}

enum TaxClassification {
  DISREGARDED_ENTITY @map("disregarded_entity") // Default for single-member
  PARTNERSHIP        @map("partnership")         // Default for multi-member
  S_CORPORATION      @map("s_corporation")
  C_CORPORATION      @map("c_corporation")
}

enum ValuationMethod {
  PROFESSIONAL_APPRAISAL @map("professional_appraisal")
  BOOK_VALUE            @map("book_value")
  FORMULA_BASED         @map("formula_based")
  MEMBER_AGREEMENT      @map("member_agreement")
}

enum MeetingFrequency {
  AS_REQUIRED @map("as_required")
  ANNUALLY    @map("annually")
  QUARTERLY   @map("quarterly")
  MONTHLY     @map("monthly")
  CUSTOM      @map("custom")
}

enum QuorumType {
  ALL_MEMBERS          @map("all_members")
  MAJORITY_MEMBERS     @map("majority_members")
  PERCENTAGE_OWNERSHIP @map("percentage_ownership")
}

enum ReportPreparer {
  COMPANY_MEMBER     @map("company_member")
  OUTSIDE_ACCOUNTANT @map("outside_accountant")
  TO_BE_DECIDED      @map("to_be_decided")
}

enum DisputeResolution {
  MEDIATION_FIRST      @map("mediation_first")
  BINDING_ARBITRATION  @map("binding_arbitration")
  CALIFORNIA_COURTS    @map("california_courts")
}

enum MemberType {
  INDIVIDUAL @map("individual")
  ENTITY     @map("entity")
}

enum ContributionType {
  CASH     @map("cash")
  PROPERTY @map("property")
  SERVICES @map("services")
}

enum UnanimousConsentType {
  AMENDING_AGREEMENT  @map("amending_agreement")
  ADDING_MEMBERS      @map("adding_members")
  SELLING_ASSETS      @map("selling_assets")
  MAJOR_DEBT          @map("major_debt")
  MAJOR_EXPENSES      @map("major_expenses")
  DISSOLVING_COMPANY  @map("dissolving_company")
  CHANGING_PURPOSE    @map("changing_purpose")
  CUSTOM              @map("custom")
}

enum BankingAuthType {
  ANY_MEMBER           @map("any_member")
  SPECIFIC_MEMBERS     @map("specific_members")
  MANAGERS_ONLY        @map("managers_only")
  MULTIPLE_SIGNATURES  @map("multiple_signatures")
}

enum DissolutionTriggerType {
  UNANIMOUS_VOTE            @map("unanimous_vote")
  MAJORITY_VOTE             @map("majority_vote")
  MEMBER_DEATH              @map("member_death")
  MEMBER_BANKRUPTCY         @map("member_bankruptcy")
  BUSINESS_PURPOSE_ACHIEVED @map("business_purpose_achieved")
  CUSTOM                    @map("custom")
}

// ======================================
// Hybrid Payments                    ==
// ======================================

model SubscriptionIntent {
  id                String   @id @default(cuid())
  orderId           String   @map("order_id")
  customerId        String   @map("customer_id")
  paymentMethodId   String   @map("payment_method_id")
  service           String
  amount            Decimal  @db.Decimal(10, 2)
  frequency         SubscriptionFrequency
  delayDays         Int      @map("delay_days")
  scheduledDate     DateTime @map("scheduled_date")
  status            SubscriptionIntentStatus @default(PENDING)
  provider          PaymentProvider @default(STRIPE)
  
  // Customer info for processing
  customerEmail     String   @map("customer_email")
  customerName      String   @map("customer_name")
  companyName       String   @map("company_name")
  
  // Stripe details
  stripeSubscriptionId String? @map("stripe_subscription_id")
  stripePriceId        String? @map("stripe_price_id")
  
  // PayPal details
  paypalBillingAgreementId String? @map("paypal_billing_agreement_id")
  
  // Processing info
  retryCount        Int      @default(0) @map("retry_count")
  maxRetries        Int      @default(3) @map("max_retries")
  lastRetryAt       DateTime? @map("last_retry_at")
  processedAt       DateTime? @map("processed_at")
  failureReason     String?  @map("failure_reason")
  
  // Timestamps
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  // Relationships
  order             Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  @@map("subscription_intents")
}

enum SubscriptionFrequency {
  MONTHLY @map("monthly")
  YEARLY  @map("yearly")
}

enum SubscriptionIntentStatus {
  PENDING    @map("pending")
  SCHEDULED  @map("scheduled")
  ACTIVE     @map("active")
  FAILED     @map("failed")
  CANCELLED  @map("cancelled")
  EXPIRED    @map("expired")
}

enum PaymentProvider {
  STRIPE  @map("stripe")
  PAYPAL  @map("paypal")
}

model PaymentMethodVault {
  id            String   @id @default(cuid())
  provider      PaymentProvider
  customerId    String   @map("customer_id")
  vaultId       String   @map("vault_id") // Stripe payment_method_id or PayPal billing_token
  customerEmail String   @map("customer_email")
  customerName  String   @map("customer_name")
  companyName   String   @map("company_name")
  isActive      Boolean  @default(true) @map("is_active")
  metadata      Json?    // Store additional provider-specific data
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  @@unique([provider, customerId])
  @@map("payment_method_vaults")
}